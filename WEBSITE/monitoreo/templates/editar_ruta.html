{% block content %}

<!-- Agregar Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Agregar Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">


<style>
    body {
        background-color: #f0f0f0; /* Fondo gris claro */
    }
    
    .custom-card {
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
        width: 90%;
        max-width: 1100px;
    }
    .custom-header {
        font-weight: bold;
        color: #2c3e50;
    }
    .custom-btn {
        border-radius: 10px;
        font-weight: bold;
        padding: 12px 25px;
    }
</style>

<div class="container mt-4 d-flex flex-column align-items-center">
    <h2 class="mb-4 text-center text-primary">‚úèÔ∏è Editar Ruta</h2>

    <div class="card custom-card mb-4">
        <form method="POST">
            {% csrf_token %}
            <div class="mb-3">
                <label for="nombre_ruta" class="form-label custom-header">Nombre de la Ruta</label>
                <input type="text" id="nombre_ruta" name="nombre_ruta" class="form-control" value="{{ ruta.nombre_ruta }}" required>
            </div>
            <div class="mb-3">
                <label for="descripcion" class="form-label custom-header">Descripci√≥n</label>
                <textarea id="descripcion" name="descripcion" class="form-control" required>{{ ruta.descripcion }}</textarea>
            </div>

            
    <div class="d-flex justify-content-center">
        <button type="submit" class="btn btn-primary btn-lg custom-btn">üíæ Guardar Cambios</button>
        <a href="{% url 'lista_rutas' %}" class="btn btn-danger btn-lg ms-3 custom-btn">‚ùå Cancelar</a>
    </div>
        </form>
    </div>



    <div class="card custom-card mb-4">
        <h3 class="text-center text-secondary">üîó Dispositivos Asociados</h3>
        <table class="table mt-3 table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Orden</th>
                    <th>Nombre</th>
                    <th>IP</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tabla-dispositivos">
                {% for relacion in dispositivos_ruta %}
                <tr id="dispositivo-{{ relacion.id }}" data-id-inventario="{{ relacion.id_inventario.id_inventario }}">
                    <td class="orden-columna">{{ relacion.orden }}</td>
                    <td>{{ relacion.id_inventario.nombre }}</td>
                    <td>{{ relacion.id_inventario.ip }}</td>
                    <td>
                        <button class="btn btn-danger btn-lg" onclick="eliminarDispositivo({{ ruta.id_ruta }}, {{ relacion.id }})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
    
        <!-- Bot√≥n para mostrar el formulario -->
        <div class="text-center mt-3">
            <button class="btn btn-success btn-lg" onclick="toggleFormulario()">
                <i class="fas fa-plus"></i> Agregar Dispositivo
            </button>
        </div>
    
        <!-- Tarjeta del formulario (oculta al inicio) -->
        <div id="formulario-agregar" class="card p-3 mt-3" style="display: none;">
            <h4 class="text-center text-primary">‚ûï Buscar y Agregar Dispositivo</h4>
        
            <!-- Barra de b√∫squeda -->
            <div class="mb-3">
                <label for="buscar_ip" class="form-label">Buscar por IP</label>
                <input type="text" id="buscar_ip" class="form-control" placeholder="Ej: 192.168.1.100" oninput="buscarDispositivos()">
            </div>
        
            <!-- Lista de dispositivos encontrados -->
            <div id="resultado-busqueda" class="mb-3">
                <p class="text-muted text-center">Escribe una IP para buscar dispositivos.</p>
            </div>
        
            <!-- Botones de acci√≥n -->
            <div class="text-center">
                <!--
                <button class="btn btn-primary btn-lg" onclick="agregarSeleccionados({{ ruta.id_ruta }})">
                    <i class="fas fa-save"></i> Agregar Seleccionados
                </button>
                -->
                <button class="btn btn-primary btn-lg" onclick="event.preventDefault(); agregarSeleccionado({{ ruta.id_ruta }});">
                    <i class="fas fa-save"></i> Agregar Dispositivo
                </button>                
                
                <button class="btn btn-secondary btn-lg" onclick="toggleFormulario()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>

<script>
    let dispositivosSeleccionados = [];
    let dispositivosEnRuta = new Set(); // Iniciamos vac√≠o

    function actualizarDispositivosEnRuta() {
        dispositivosEnRuta.clear(); // üî• Limpiar antes de actualizar
    
        document.querySelectorAll("#tabla-dispositivos tbody tr").forEach(row => {
            let idInventario = row.getAttribute("data-id-inventario");
            if (idInventario) {
                dispositivosEnRuta.add(parseInt(idInventario));
            }
        });
    
        console.log("‚úÖ dispositivosEnRuta actualizado:", Array.from(dispositivosEnRuta));
    }
    
    // Llamamos a la funci√≥n al cargar la p√°gina
    document.addEventListener("DOMContentLoaded", actualizarDispositivosEnRuta);

    function actualizarDispositivosEnRuta() {
        dispositivosEnRuta.clear(); // üî• Limpiar antes de actualizar
    
        let filas = document.querySelectorAll("#tabla-dispositivos tr");
    
        if (filas.length === 0) {
            console.warn("‚ö†Ô∏è No se encontraron dispositivos en la tabla.");
            return;
        }
    
        filas.forEach(row => {
            let idInventario = row.getAttribute("data-id-inventario");
    
            if (!idInventario) {
                console.warn("‚ö†Ô∏è Esta fila no tiene data-id-inventario:", row);
            } else {
                dispositivosEnRuta.add(parseInt(idInventario));
                console.log(`‚úÖ Agregado a dispositivosEnRuta: ${idInventario}`);
            }
        });
    
        console.log("üîÑ Dispositivos en ruta actualizados:", Array.from(dispositivosEnRuta));
    }
    

    window.dispositivoSeleccionado = null;  // Definir en el √°mbito global

    function seleccionarDispositivo(radio) {
        console.log("üî• seleccionarDispositivo() fue llamada.");  
    
        if (!radio) {
            console.warn("‚ö†Ô∏è No se recibi√≥ ning√∫n radio button.");
            return;
        }
    
        let id = radio.value;
        let nombre = radio.getAttribute("data-nombre");
        let ip = radio.getAttribute("data-ip");
    
        console.log("üîç ID seleccionado:", id);
        console.log("üîç Nombre:", nombre);
        console.log("üîç IP:", ip);
    
        window.dispositivoSeleccionado = { id, nombre, ip };
        console.log("‚úÖ FINAL - Dispositivo guardado en window:", window.dispositivoSeleccionado);
    }
    
    function actualizarDispositivosEnRuta() {
    dispositivosEnRuta = new Set();  // üî• Reiniciar el Set manualmente para asegurarnos de que est√° limpio

    let filas = document.querySelectorAll("#tabla-dispositivos tr");

    if (filas.length === 0) {
        console.warn("‚ö†Ô∏è No se encontraron dispositivos en la tabla.");
        return;
    }

    filas.forEach(row => {
        let idInventario = row.getAttribute("data-id-inventario");

        if (!idInventario) {
            console.warn("‚ö†Ô∏è Esta fila no tiene data-id-inventario:", row);
        } else {
            let idNumerico = Number(idInventario);  // üî• Convertir a n√∫mero de manera segura
            dispositivosEnRuta.add(idNumerico);
            console.log(`‚úÖ Agregado a dispositivosEnRuta: ${idNumerico}`);
        }
    });

    console.log("üîÑ dispositivosEnRuta actualizado:", Array.from(dispositivosEnRuta));
}

    console.log("üìå Dispositivos en la ruta:", dispositivosEnRuta);
    
    function eliminarDispositivo(id_ruta, id_dispositivo) {
        // üîç Verificaci√≥n de `id_ruta`
        if (!id_ruta || isNaN(id_ruta)) {
            console.error("‚ùå Error: `id_ruta` no es v√°lido:", id_ruta);
            return;
        }
    
        const url = `/monitoreo/ruta/${id_ruta}/eliminar-dispositivo/${id_dispositivo}/`;
        console.log("üìå URL de eliminaci√≥n generada:", url);  // Debug
    
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("‚úÖ Dispositivo eliminado correctamente:", id_dispositivo);
    
                // üîÑ Eliminar el dispositivo de la tabla
                document.getElementById(`dispositivo-${id_dispositivo}`).remove();
    
                // üî• Se actualiza la lista de dispositivos en ruta
                actualizarTablaDesdeServidor(id_ruta);
                actualizarDispositivosEnRuta();
                buscarDispositivos();
            } else {
                console.error("‚ùå Error al eliminar:", data.error);
            }
        })
        .catch(error => console.error("‚ùå Error en la petici√≥n:", error));
    }
    

    function actualizarOrden() {
        let dispositivos = [];  // Aqu√≠ tendr√°s los dispositivos con su nuevo orden
        let filas = document.querySelectorAll("#tabla-dispositivos tr");
    
        filas.forEach((fila, index) => {
            let id_dispositivo = fila.getAttribute("data-id");  // Aseg√∫rate de tener un atributo "data-id" en cada fila
            dispositivos.push(`${id_dispositivo}_${index + 1}`);
        });
    
        fetch(`/ruta/${rutaId}/actualizar-orden/`, {
            method: 'POST',
            body: new URLSearchParams({
                'dispositivos[]': dispositivos
            }),
            headers: {
                'X-CSRFToken': csrfToken  // Aseg√∫rate de incluir el token CSRF para proteger la solicitud
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Orden actualizado correctamente');
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Hubo un error al actualizar el orden');
        });
    }
    
    function reordenarTabla() {
        let filas = Array.from(document.querySelectorAll("#tabla-dispositivos tr"));
        filas.sort((a, b) => {
            let ordenA = parseInt(a.querySelector('.orden-columna').textContent);
            let ordenB = parseInt(b.querySelector('.orden-columna').textContent);
            return ordenA - ordenB;
        });
    
        let tabla = document.querySelector("#tabla-dispositivos");
        filas.forEach(fila => tabla.appendChild(fila));  // Vuelve a agregar las filas en el orden correcto
    }
    
    function actualizarOrdenDispositivo(idDispositivo, nuevoOrden) {
        // Realizamos la actualizaci√≥n de orden de un dispositivo en el backend si es necesario
        fetch(`/monitoreo/ruta/actualizar-orden/${idDispositivo}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ nuevoOrden: nuevoOrden })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`Orden actualizado para el dispositivo ${idDispositivo}`);
            } else {
                console.error("Error al actualizar el orden:", data.error);
            }
        })
        .catch(error => console.error("Error en la solicitud:", error));
    }

    function agregarDispositivo(id_ruta) {
        let ip = document.getElementById("ip_dispositivo").value.trim();
        
        if (!ip) {
            alert("Por favor, ingresa una direcci√≥n IP v√°lida.");
            return;
        }

        fetch(`/monitoreo/ruta/${id_ruta}/agregar-dispositivo/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ip: ip })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let tabla = document.getElementById("tabla-dispositivos");
                let newRow = document.createElement("tr");
                newRow.id = `dispositivo-${data.id}`;

                newRow.innerHTML = `
                    <td class="orden-columna">${tabla.rows.length + 1}</td>
                    <td>${data.nombre}</td>
                    <td>${data.ip}</td>
                    <td>
                        <button class="btn btn-danger btn-lg" onclick="eliminarDispositivo(${id_ruta}, ${data.id})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;

                tabla.appendChild(newRow);
                document.getElementById("ip_dispositivo").value = "";
                toggleFormulario();
                actualizarDispositivosEnRuta();  // üî• Se actualiza en tiempo real
                buscarDispositivos();
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(error => console.error("Error en la petici√≥n:", error));
    }

    function toggleFormulario() {
        let form = document.getElementById("formulario-agregar");
        form.style.display = (form.style.display === "none" || form.style.display === "") ? "block" : "none";
    }
    
    function buscarDispositivos() {
        let ip = document.getElementById("buscar_ip").value.trim();
        let resultadoDiv = document.getElementById("resultado-busqueda");
    
        if (ip.length < 3) {
            resultadoDiv.innerHTML = '<p class="text-muted text-center">Escribe una IP para buscar dispositivos.</p>';
            return;
        }
    
        fetch(`/monitoreo/buscar-dispositivo/?ip=${ip}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    resultadoDiv.innerHTML = '<p class="text-danger text-center">No se encontraron dispositivos.</p>';
                    return;
                }
    
                let lista = '<ul class="list-group">';
                data.forEach(dispositivo => {
                    let idNumerico = Number(dispositivo.id_inventario);
                    let disabled = dispositivosEnRuta.has(idNumerico) ? "disabled" : "";  // üî• Bloquear si ya est√° en la ruta
    
                    lista += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>${dispositivo.nombre} - ${dispositivo.ip}</span>
                            <input type="radio" name="seleccionDispositivo" value="${dispositivo.id_inventario}"
                                   data-nombre="${dispositivo.nombre}" data-ip="${dispositivo.ip}"
                                   onchange="seleccionarDispositivo(this)" ${disabled}>
                        </li>`;
                });
                lista += '</ul>';
                resultadoDiv.innerHTML = lista;
    
                console.log("üîÑ Se actualiz√≥ la b√∫squeda con dispositivos en ruta:", Array.from(dispositivosEnRuta));
            })
            .catch(error => console.error("‚ùå Error en la b√∫squeda:", error));
    }
    

    function agregarSeleccionado(id_ruta) {
        console.log("üõ† Intentando agregar dispositivo:", window.dispositivoSeleccionado);
    
        if (!window.dispositivoSeleccionado) {
            alert("Selecciona un dispositivo antes de agregarlo.");
            return;
        }
    
        let datosEnvio = { ip: window.dispositivoSeleccionado.ip };
    
        console.log("üì§ Enviando datos al backend:", JSON.stringify(datosEnvio));
    
        fetch(`/monitoreo/ruta/${id_ruta}/agregar-dispositivo/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify(datosEnvio)
        })
        .then(async response => {
            let data = await response.json();
            console.log("‚úÖ Respuesta del servidor:", data);
            if (response.ok) {
                toggleFormulario();
                actualizarTablaDesdeServidor(id_ruta);  // üî• Recarga la tabla autom√°ticamente
                setTimeout(() => {
                    console.log("üìå Limpiando selecci√≥n despu√©s de agregar el dispositivo.");
                    window.dispositivoSeleccionado = null;
                }, 1000);
            } else {
                console.error("‚ùå Error en la solicitud:", data);
                alert(`‚ùå Error: ${data.error || "Solicitud inv√°lida"}`);
            }
        })
        .catch(error => console.error("‚ùå Error en la solicitud:", error));
    }
    
    
    
    function obtenerDispositivosRuta(idRuta) {
        fetch(`/monitoreo/ruta/${idRuta}/dispositivos/`)
            .then(response => response.json())
            .then(data => {
                if (data.dispositivos && data.dispositivos.length > 0) {
                    // Actualizar dispositivosEnRuta con los dispositivos obtenidos
                    data.dispositivos.forEach(dispositivo => {
                        dispositivosEnRuta.add(dispositivo.id_inventario);
                    });
                    actualizarTablaDispositivos(data.dispositivos);
                } else {
                    console.log("No se encontraron dispositivos para esta ruta.");
                }
            })
            .catch(error => console.error("Error al obtener dispositivos:", error));
    }


    function actualizarTablaDispositivos(dispositivos) {
        console.log("üîÑ Actualizando la tabla con nuevos dispositivos...");
        console.log("üì• Dispositivos recibidos:", dispositivos);
    
        const tablaDispositivos = document.getElementById("tabla-dispositivos");
        if (!tablaDispositivos) {
            console.error("‚ùå No se encontr√≥ la tabla en el DOM.");
            return;
        }
    
        tablaDispositivos.innerHTML = '';  // üî• Limpiar antes de actualizar
    
        if (!dispositivos || dispositivos.length === 0) {
            console.warn("‚ö†Ô∏è No hay dispositivos en la ruta.");
            tablaDispositivos.innerHTML = `<tr><td colspan="4" class="text-center">No hay dispositivos en la ruta.</td></tr>`;
            return;
        }
    
        dispositivos.forEach(relacion => {
            console.log("‚ûï Agregando dispositivo:", relacion);
    
            const row = document.createElement("tr");
            row.id = `dispositivo-${relacion.id}`;
            row.setAttribute('data-id-inventario', relacion.id_inventario);
    
            row.innerHTML = `
                <td class="orden-columna">${relacion.orden}</td>
                <td>${relacion.nombre}</td> <!-- Coincide con {{ relacion.id_inventario.nombre }} -->
                <td>${relacion.ip}</td> <!-- Coincide con {{ relacion.id_inventario.ip }} -->
                <td>
                    <button class="btn btn-danger btn-lg" onclick="eliminarDispositivo(${relacion.id_ruta}, ${relacion.id})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
    
            console.log(`üìå Bot√≥n generado: eliminarDispositivo(${relacion.id_ruta}, ${relacion.id})`);
    
            tablaDispositivos.appendChild(row);
        });
    
        console.log("‚úÖ Tabla actualizada correctamente.");
    }
    
    
    function actualizarDispositivosSeleccionados() {
        // Limpiar la b√∫squeda y actualizar la lista de dispositivos
        let ip = document.getElementById("buscar_ip").value.trim();
        let resultadoDiv = document.getElementById("resultado-busqueda");
    
        fetch(`/monitoreo/buscar-dispositivo/?ip=${ip}`)
        .then(response => response.json())
        .then(data => {
            if (data.length === 0) {
                resultadoDiv.innerHTML = '<p class="text-danger text-center">No se encontraron dispositivos.</p>';
                return;
            }
    
            let lista = '<ul class="list-group">';
            data.forEach(dispositivo => {
                // Verificar si el dispositivo ya est√° en la ruta o si est√° en la lista de seleccionados
                let checked = dispositivosEnRuta.has(dispositivo.id_inventario) || dispositivosSeleccionados.some(d => d.id === dispositivo.id_inventario) ? "checked disabled" : "";
    
                lista += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${dispositivo.nombre} - ${dispositivo.ip}</span>
                        <input type="checkbox" value="${dispositivo.id_inventario}" onclick="seleccionarDispositivo(this, '${dispositivo.nombre}', '${dispositivo.ip}')" ${checked}>
                    </li>`;
            });
            lista += '</ul>';
            resultadoDiv.innerHTML = lista;
        })
        .catch(error => console.error("Error en la b√∫squeda:", error));
    }
    
    function inicializarDispositivosEnRuta() {
        dispositivosEnRuta = new Set();
    
        document.querySelectorAll("#tabla-dispositivos tbody tr").forEach(row => {
            let idInventario = row.getAttribute("data-id-inventario");
            if (idInventario) {
                dispositivosEnRuta.add(parseInt(idInventario));
            }
        });
    
        console.log("‚úÖ dispositivosEnRuta inicializado:", Array.from(dispositivosEnRuta));
    }
    
    // Llamamos a la funci√≥n cuando la p√°gina carga
    // document.addEventListener("DOMContentLoaded", inicializarDispositivosEnRuta);
    
    function actualizarTablaDesdeServidor(idRuta) {
        fetch(`/monitoreo/ruta/${idRuta}/dispositivos/`)
            .then(response => response.json())
            .then(data => {
                if (data.dispositivos && data.dispositivos.length > 0) {
                    actualizarTablaDispositivos(data.dispositivos);  // üî• Actualiza la tabla con los nuevos dispositivos
                    actualizarDispositivosEnRuta();  // üîÑ Vuelve a calcular dispositivosEnRuta
                    buscarDispositivos();  // üîÑ Refresca la lista de b√∫squeda
                } else {
                    console.log("‚ùå No se encontraron dispositivos en la ruta.");
                    document.getElementById("tabla-dispositivos").innerHTML = '<tr><td colspan="4" class="text-center">No hay dispositivos en la ruta.</td></tr>';
                    actualizarDispositivosEnRuta();
                }
            })
            .catch(error => console.error("‚ùå Error al obtener dispositivos:", error));
    }
    
    
</script>

{% endblock %}
